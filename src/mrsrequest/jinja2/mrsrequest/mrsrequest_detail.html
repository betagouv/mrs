{% extends 'crudlfap/detail.html' %}

{% block breadcrumb %}
<nav>
  <div class="nav-wrapper">
    <div class="col s12">
      <a
        class="breadcrumb"
        style="padding-left: 1em"
        href="{{ crudlfap_site.views['home'].url }}"
      >{{ _('Home') }}</a>
      {% set v = crudlfap_site[view.model]['list'](request=request) %}
      <a
        class="breadcrumb"
        href="{{ v.reverse() }}"
      >{{ v.model._meta.verbose_name_plural.capitalize() }}</a>
      {% for value, label in view.model.STATUS_CHOICES %}
        {% if object.status == value %}
          <a
            class="breadcrumb"
            href="{{ v.reverse() }}?status={{ object.status }}"
          >{{ label }}</a>
        {% endif %}
      {% endfor %}
      {% if object and getattr(object, 'get_absolute_url', None) %}
        <a class="breadcrumb" href="{{ object.get_absolute_url() }}">{{ object }}</a>
      {% endif %}
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <span
                    data-position="bottom"
                    data-tooltip="{{ object.tooltip }}"
                    class="card-title tooltipped activator {{ object.color }}-text"
                >{{ object.display_id }}<i class="material-icons right">more_vert</i></span>
                <div class="section">
                    <p>
                        <span class="grey-text text-darken-2">
                            Soumise
                        </span>
                        <span class="right">
                            {{ localtime(object.creation_datetime).strftime('%d/%m/%Y %H:%M') }}
                        </span>
                    </p>
                    {% if object.mandate_date -%}
                    <p>
                        <span class="grey-text text-darken-2">
                            Date de mandatement
                        </span>
                        <span class="right">
                            {{ localtime(object.mandate_date).strftime('%d/%m/%Y') }}
                        </span>
                    </p>
                    {% endif -%}
                    {% if object.delay -%}
                    <p>
                        <span class="grey-text text-darken-2">
                            Délai de paiement
                        </span>
                        <span class="right">
                            {{ object.delay }}
                        </span>
                    </p>
                    {% endif -%}
                </div>
            </div>
            <div class="card-reveal">
                <span class="card-title grey-text text-darken-4">{{ naturalsize(object.total_size) }} <span style="font-size: 50% !important">{{ object.creation_ip }}</span><i class="material-icons right">close</i></span>
                <div class="section">
                    {{ object.caisse }}
                    {% if object.insured.shifted %}
                    <br />
                    Basculé
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% with entries = list(object.logentry_set()) %}
    {% if entries %}
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                {% for entry in entries %}
                <div class="{% if loop.index == 1 %}card-title{% endif %} {% if entry.action_flag == 999 %}red-text{% endif %}{% if entry.action_flag == 1000 %}yellow-text text-darken-3{% endif %}{% if entry.action_flag == 2000 %}green-text{% endif %}">
                    {{ entry.change_message }}
                </div>
                {{ localtime(entry.action_time).strftime('%d/%m/%Y %H:%M') }}
                <span class="right">
                    {{ entry.user }}
                </span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endwith %}
</div>
<div class="row">
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Personne transportée
                </div>
                <p>
                    <span class="grey-text text-darken-2">
                        PMT
                    </span>
                    <span class="right">
                        <a
                            href="{{ object.pmt.get_download_url() }}"
                            title="{{ object.pmt.filename }}"
                            {% if object.pmt.filename.lower().endswith('pdf') %}
                            target="_blank"
                            {% else %}
                            data-controller="viewerjs"
                            data-action="click->viewerjs#click"
                            data-viewerjs="uploads"
                            {% endif %}
                        >{{ object.pmt.filename }} ({{ naturalsize(object.pmt.binary|length) }})</a>
                    </span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Prénom
                    </span>
                    <span class="right">{{ object.insured.first_name }}</span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Nom
                    </span>
                    <span class="right">{{ object.insured.last_name }}</span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Date de naissance
                    </span>
                    <span class="right">{{ object.insured.birth_date.strftime('%d/%m/%Y') }}</span>
                </p>
            </div>
        </div>
    </div>
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Assuré-e
                </div>
                <p>
                    <span class="grey-text text-darken-2">
                        NIR
                    </span>
                    <span class="right">{{ object.insured.nir }}</span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Email
                    </span>
                    <span class="right">{{ object.insured.email }}</span>
                </p>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Transport(s)
                </div>
                <p>
                    <span class="red-text" style="font-weight: bold">
                        Montant total (Base de remboursement)
                    </span>
                    <span class="right red-text" style="font-weight: bold">
                        {{ '%.2f'|format((object.distance * 0.3) + float(object.expense)) }}€ TTC
                    </span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Distance (km parcourus)
                    </span>
                    <span class="right">
                        {{ object.distance }}
                    </span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Montant des km parcourus
                    </span>
                    <span class="right">
                        {{ '%.2f'|format(object.distance * 0.3) }}€ TTC
                    </span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Montant total des frais
                    </span>
                    <span class="right">
                        {{ object.expense }}€ TTC
                    </span>
                </p>
                {% if object.payment_base -%}
                <p>
                    <span class="grey-text text-darken-2">
                        Base de remboursement
                    </span>
                    <span class="right">
                        {{ object.payment_base }}€
                    </span>
                </p>
                {% endif %}
                {% if object.payment_amount -%}
                <p>
                    <span class="grey-text text-darken-2">
                        Montant remboursé
                    </span>
                    <span class="right">
                        {{ object.payment_amount }}€
                    </span>
                </p>
                {% endif -%}
                {% if object.taxi_cost -%}
                <p>
                    <span class="grey-text text-darken-2">
                        Coût théorique du trajet en taxi
                    </span>
                    <span class="right">
                        {{ object.taxi_cost }}€
                    </span>
                </p>
                {% endif -%}
                {% if object.saving -%}
                <p>
                    <span class="grey-text text-darken-2">
                        Economie calculée
                    </span>
                    <span class="right">
                        {{ object.saving }}€
                    </span>
                </p>
                {% endif -%}
                <table class="centered highlight">
                    <thead>
                        <tr>
                            <th>Num.</th>
                            <th>Aller</th>
                            <th>Retour</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transport in object.transport_set.all() %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ transport.date_depart.strftime('%d/%m/%Y') }}</td>
                            <td>{{ transport.date_return.strftime('%d/%m/%Y') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% if object.expense %}
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Justificatif{% if object.bill_set.all()|length > 1 %}s{% endif %} attaché{% if object.bill_set.all()|length > 1 %}s{% endif %}
                </div>
                <ul>
                {% for bill in object.bill_set.all() %}
                    <li>
                        <a
                            href="{{ bill.get_download_url() }}"
                            {% if bill.filename.lower().endswith('pdf') %}
                            target="_blank"
                            {% else %}
                            data-controller="viewerjs"
                            data-action="click->viewerjs#click"
                            data-viewerjs="uploads"
                            {% endif %}
                        >{{ bill.filename }} ({{ naturalsize(bill.binary|length) }})</a>
                    </li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endif %}
</div>
{% endblock %}
