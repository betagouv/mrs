{% extends 'crudlfap/detail.html' %}

{% block content %}
<div class="row">
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <span
                    data-position="bottom"
                    data-tooltip="En attente de traitement depuis {{ object.days }} jours"
                    class="card-title tooltipped activator {{ object.color }}-text"
                >{{ object.display_id }}<i class="material-icons right">more_vert</i></span>
                <div class="section">
                    Soumise
                    <span class="right">
                        {{ localtime(object.creation_datetime).strftime('%d/%m/%y %H:%M') }}
                    </span>
                </div>
            </div>
            <div class="card-reveal">
                <span class="card-title grey-text text-darken-4">{{ naturalsize(object.total_size) }} <span style="font-size: 50% !important">{{ object.creation_ip }}</span><i class="material-icons right">close</i></span>
                <div class="section">
                    {{ object.caisse }}
                </div>
            </div>
        </div>
    </div>
    {% with entries = list(object.logentry_set()) %}
    {% if entries %}
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                {% for entry in entries %}
                <div class="{% if loop.index == 1 %}card-title{% endif %} {% if entry.action_flag == 999 %}red-text{% endif %}{% if entry.action_flag == 1000 %}yellow-text text-darken-3{% endif %}{% if entry.action_flag == 2000 %}green-text{% endif %}">
                    {{ entry.change_message }}
                </div>
                {{ localtime(entry.action_time).strftime('%d/%m/%y %H:%M') }}
                <span class="right">
                    {{ entry.user }}
                </span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endwith %}
</div>
<div class="row">
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Personne transportée
                </div>
                <a
                    href="{{ object.pmt.get_download_url() }}"
                    title="{{ object.pmt.filename }}"
                    data-controller="viewerjs"
                    data-action="click->viewerjs#click"
                    data-viewerjs="uploads"
                    target="_blank"
                >PMT ({{ naturalsize(object.pmt.binary|length) }})</a>
                <p>
                    <span class="grey-text text-darken-2">
                        Prénom
                    </span>
                    <span class="right">{{ object.insured.first_name }}</span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Nom
                    </span>
                    <span class="right">{{ object.insured.last_name }}</span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Date de naissance
                    </span>
                    <span class="right">{{ object.insured.birth_date.strftime('%d/%m/%y') }}</span>
                </p>
            </div>
        </div>
    </div>
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Assuré-e
                </div>
                <p>
                    <span class="grey-text text-darken-2">
                        NIR
                    </span>
                    <span class="right">{{ object.insured.nir }}</span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Email
                    </span>
                    <span class="right">{{ object.insured.email }}</span>
                </p>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Transport(s)
                </div>
                <p>
                    <span class="grey-text text-darken-2">
                        Distance (km parcourus)
                    </span>
                    <span class="right">
                        {{ object.distance }}
                    </span>
                </p>
                <p>
                    <span class="grey-text text-darken-2">
                        Montant total des frais
                    </span>
                    <span class="right">
                        {{ object.expense }}€ TTC
                    </span>
                </p>
                <table class="centered highlight">
                    <thead>
                        <tr>
                            <th>Num.</th>
                            <th>Aller</th>
                            <th>Retour</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transport in object.transport_set.all() %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ transport.date_depart.strftime('%d/%m/%y') }}</td>
                            <td>{{ transport.date_return.strftime('%d/%m/%y') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% if object.expense %}
    <div class="col m6 s12">
        <div class="card">
            <div class="card-content">
                <div class="card-title">
                    Justificatif{% if object.bill_set.all()|length > 1 %}s{% endif %} attaché{% if object.bill_set.all()|length > 1 %}s{% endif %}
                </div>
                {% for bill in object.bill_set.all() %}
                <ul>
                    <li>
                        <a
                            href="{{ bill.get_download_url() }}"
                            target="_blank"
                            data-controller="viewerjs"
                            data-action="click->viewerjs#click"
                            data-viewerjs="uploads"
                        >{{ bill.filename }} ({{ naturalsize(bill.binary|length) }})</a>
                    </li>
                </ul>
                {% endfor %}
            </div>
        </div>
    </div>
{% endif %}
</div>

<ul style="display: none" id="uploads">
  <li>
    <img data-original="{{ object.pmt.get_download_url() }}" src="{{ object.pmt.get_download_url() }}" alt="{{ object.pmt.filename }} ({{ naturalsize(object.pmt.binary|length) }})" />
  </li>
  {% for bill in object.bill_set.all() %}
  <li>
      <img data-original="{{ bill.get_download_url() }}" src="{{ bill.get_download_url() }}" alt="{{ bill.filename }} ({{ naturalsize(bill.binary|length) }})"/>
  </li>
  {% endfor %}
</ul>
{% endblock %}
