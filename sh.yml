---
name: env
hook: before jobs
help: Global environment variables
env:
  DB_ENGINE: django.db.backends.postgresql
  DB_NAME: mrs
  DEBUG: 1
  DJANGO_SETTINGS_MODULE: mrs.settings

---
name: dbreset
color: red
help: Drop and re-create the database
script: |
  sudo systemctl start postgresql
  sudo -u postgres dropdb mrs || echo could not drop db
  sudo -u postgres createdb -E utf8 -O $USER mrs

---
name: dbreload
color: red
help: Drop and re-create the database, load test data
requires: [dbreset, dbload]

---
name: dbload
help: Load test data
script: |
  mrs migrate --noinput
  djcli delete contenttypes.ContentType
  djcli delete auth.Group
  djcli delete mrsuser.User
  CI=1 mrs loaddata src/mrs/tests/data.json

---
name: dbdump
help: Dump test data
script:
- CI=1 mrs mrsstat --refresh
- mrs
    dumpdata
    --indent=4
    $(grep model src/mrs/tests/data.json | sort -u | sed 's/.*model". "\([^"]*\)",*/\1/')
    > src/mrs/tests/data.json

---
name: fixturereset
help: Reset the generate fixture files
script:
- FIXTURE_REWRITE=1 tox -e py37-dj21 -- -s
